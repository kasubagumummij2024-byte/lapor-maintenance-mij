<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Kasubag - Sistem Laporan MIJ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
        <div><h1 class="text-2xl font-bold text-teal-400">Madrasah Istiqlal Jakarta — Sistem Laporan</h1><p class="text-sm text-gray-400">Maintenance & Support - Transparan · Terukur · Terverifikasi</p></div>
        <nav class="space-x-2 flex items-center" id="nav-buttons"></nav>
    </header>
    <main class="min-h-[520px] bg-gray-800/50 rounded-lg p-4">
        <div class="bg-gray-800 p-6 rounded-2xl shadow text-gray-200">
            <h2 class="text-xl font-semibold text-teal-400 mb-3">Panel Kasubag Umum - Laporan Menunggu Penugasan</h2>
            <div class="flex items-center space-x-3 mb-4 bg-gray-900/50 p-3 rounded-md">
                <label for="urgensiFilter" class="font-medium">Filter Urgensi:</label>
                <select id="urgensiFilter" class="p-2 bg-gray-900 border border-gray-700 rounded"><option>Semua</option><option>Mendesak</option><option>Normal</option><option>Biasa</option></select>
                <button onclick="loadPendingReports()" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 rounded">Filter</button>
            </div>
            <div id="content"></div>
        </div>
    </main>
    <footer class="mt-8 text-sm text-gray-500 text-center">&copy; Madrasah Istiqlal Jakarta</footer>
  </div>
  <div id="appModal" class="modal-backdrop"><div class="modal-content"><h3 id="modalTitle" class="text-lg font-bold"></h3><div id="modalBody"></div><div id="modalFooter" class="mt-6 flex justify-end space-x-3"><button id="modalCancelBtn" class="px-4 py-2 bg-gray-600 rounded">Batal</button><button id="modalConfirmBtn" class="px-4 py-2 bg-teal-600 rounded">Konfirmasi</button></div></div></div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script>
      const firebaseConfig = {
            apiKey: "AIzaSyDltfCcasmcgatDZLyXjad0c6rvJlkLNvM",
            authDomain: "webapp-laporan-maintenance-v3.firebaseapp.com",
            projectId: "webapp-laporan-maintenance-v3",
            storageBucket: "webapp-laporan-maintenance-v3.appspot.com",
            messagingSenderId: "164633815053",
            appId: "1:164633815053:web:e5ebaba172bab0add18d44"
      };
      firebase.initializeApp(firebaseConfig);
  </script>
  <script src="utils.js"></script>
  <script src="auth.js"></script>
  <script>
    const content = document.getElementById('content');
    const urgensiFilter = document.getElementById('urgensiFilter');
    let currentUser;

    document.addEventListener('DOMContentLoaded', async () => {
        currentUser = await auth.getUser();
        renderNavButtons(currentUser);
        loadPendingReports();
    });

    function renderNavButtons(user) {
        const navContainer = document.getElementById('nav-buttons');
        let buttonsHTML = `<a href="Index.html" class="px-4 py-2 bg-gray-800 hover:bg-teal-600 rounded">Form Laporan</a><a href="Kasubag.html" class="px-4 py-2 bg-teal-700 text-white font-bold rounded">Panel Kasubag</a><a href="Petugas.html" class="px-4 py-2 bg-gray-800 hover:bg-teal-600 rounded">Petugas</a><a href="Rekap.html" class="px-4 py-2 bg-gray-800 hover:bg-teal-600 rounded">Rekap Bulanan</a>`;
        if (user) {
            buttonsHTML += `<button onclick="auth.logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded">Logout</button>`;
        } else {
            buttonsHTML += `<a href="login.html" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded">Login Staf</a>`;
        }
        navContainer.innerHTML = buttonsHTML;
    }

    function getSlaText(urgency) {
        if (!urgency) return 'Normal (SLA: 3 Hari)';
        if (urgency.toLowerCase() === 'mendesak') return 'Mendesak (SLA: 1 Hari)';
        if (urgency.toLowerCase() === 'biasa') return 'Biasa (SLA: 7 Hari)';
        return 'Normal (SLA: 3 Hari)';
    }

    async function loadPendingReports() {
        utils.showLoading(content);
        const selectedUrgensi = urgensiFilter.value;
        let fetchUrl = '/api/reports?status=Menunggu Penugasan';
        if (selectedUrgensi && selectedUrgensi !== 'Semua') { fetchUrl += `&urgensi=${selectedUrgensi}`; }
        
        try {
            const response = await fetch(fetchUrl);
            if (!response.ok) throw new Error('Gagal memuat data');
            const data = await response.json();
            
            const formattedData = data.map(item => ({
                TicketID: item.ticketId, Pelapor: item.pelapor, Lokasi: item.lokasi || '-',
                "Tanggal Kegiatan": item.kategori === 'Support Kegiatan' ? (item.tanggalKegiatan || '-') : 'N/A',
                Urgensi: getSlaText(item.urgensi),
                OriginalUrgensi: item.urgensi, // <-- REVISI: Kirim urgensi asli untuk modal
                Deskripsi: item.deskripsi, docId: item.id
            }));
            renderView(formattedData, currentUser ? currentUser.role : null);
        } catch(err) {
            utils.showError(content, err);
        }
    }
    
    function renderView(data, userRole) {
        const options = { 
            emptyMessage: '👍 Semua laporan sudah ditugaskan.', 
            hiddenColumns: ['docId', 'OriginalUrgensi'] // <-- REVISI: Sembunyikan urgensi asli
        };
        if (userRole === 'Kasubag') {
            // REVISI: Ubah pemanggilan fungsi, kirim item.OriginalUrgensi
            options.action = { label: 'Tugaskan', render: (item) => `<button onclick="showAssignModal('${item.docId}', '${item.TicketID}', '${item.OriginalUrgensi}')" class="bg-teal-600 hover:bg-teal-700 px-3 py-1 rounded">Assign</button>` };
        }
        utils.renderTable(content, data, options);
    }

    // REVISI: Fungsi sekarang menerima 'originalUrgency'
    async function showAssignModal(docId, ticketId, originalUrgency) {
        // REVISI: Tambahkan dropdown untuk Urgensi di dalam modalBody
        const modalBody = `
            <p>Tugaskan tiket <strong>${utils.escapeHtml(ticketId)}</strong> ke:</p>
            <input id="petugasInput" type="text" class="mt-1 w-full p-2 rounded bg-gray-900" placeholder="nama/email petugas" />
            
            <label for="urgensiSelect" class="block text-sm mt-4">Sesuaikan Urgensi:</label>
            <select id="urgensiSelect" class="mt-1 w-full p-2 rounded bg-gray-900 border border-gray-700">
                <option value="Mendesak" ${originalUrgency === 'Mendesak' ? 'selected' : ''}>Mendesak</option>
                <option value="Normal" ${originalUrgency === 'Normal' ? 'selected' : ''}>Normal</option>
                <option value="Biasa" ${originalUrgency === 'Biasa' ? 'selected' : ''}>Biasa</option>
            </select>
        `;
        
        utils.showModal({
            title: 'Assign Tugas', body: modalBody, confirmText: 'Tugaskan',
            onConfirm: async () => {
                const assignee = document.getElementById('petugasInput').value;
                const newUrgensi = document.getElementById('urgensiSelect').value; // <-- REVISI: Ambil nilai urgensi baru
                
                if (!assignee) { utils.showNotification('Nama petugas harus diisi!', true); return; }
                
                try {
                    const headers = await auth.getAuthHeaders();
                    const response = await fetch(`/api/reports/${docId}`, {
                        method: 'PUT', headers: headers,
                        // REVISI: Kirim urgensi baru ke server
                        body: JSON.stringify({ 
                            status: 'Dalam Proses', 
                            assignedTo: assignee, 
                            assignedAt: new Date(),
                            urgensi: newUrgensi 
                        })
                    });
                    if(!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Aksi tidak diizinkan.');
                    }
                    const data = await response.json();
                    if (data.success) {
                        utils.showNotification('Tugas berhasil ditugaskan dan diperbarui!');
                        loadPendingReports();
                    }
                } catch (err) {
                    utils.showNotification(err.message, true);
                }
            }
        });
    }
  </script>
</body>
</html>